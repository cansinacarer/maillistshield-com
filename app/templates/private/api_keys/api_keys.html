{% set page_title = "API Keys" %}
{% extends "private/layouts/base.html" %}
{% block content %}
	<p class="mb-5">
		See our
		<a
			href="https://www.postman.com/maillistshield-team/mail-list-shield-api-reference/overview"
			target="_blank"
			>API Documentation</a
		>
		for documentation and sample API requests.
	</p>

	<h2 class="h5 border-bottom my-3 pb-2">Create a new API Key</h2>
	<div class="container ms-0">
		<div class="col-lg-12">
			<form
				method="post"
				action="{{ url_for("private_bp.api_keys") }}/create"
			>
				{{ form.hidden_tag() }}
				<div class="row my-5">
					<div class="col-md-6 p-md-0 pb-4">
						<b>Key Label</b>
						<br />
						<i>Friendly name to identify this key</i>
					</div>
					<div class="col-md-6">
						<div class="form-floating mb-3">
							{{
								form.label(class="form-control", id="keyLabel",
								placeholder="", value=current_user.keyLabel)
							}}
							<label for="keyLabel">Key label</label>
						</div>
					</div>
				</div>
				<div class="row my-5">
					<div class="col-md-6 p-md-0 pb-4">
						<b>Expiration Date</b>
						<br />
						<i>Leave blank to make it never expire</i>
					</div>
					<div class="col-md-6">
						<div class="form-floating mb-3">
							{{
								form.expires_at(class="form-control", id="expired_at",
								placeholder="",
								value="current_user.expired_at")
							}}
							<label for="expired_at">Expiry Date</label>
						</div>
						<input
							class="btn btn-primary mt-4"
							type="submit"
							value="Create a new API key"
						/>
					</div>
				</div>
			</form>
		</div>
	</div>

	<h2 class="h5 border-bottom my-3 pb-2">Manage API Keys</h2>
	<div class="col-lg-12">
		{% if current_user.api_keys %}
			<div class="table-responsive mb-4" style="max-height: 400px;">
				<table class="table table-striped table-hover">
					<thead>
						<tr>
							<th>Label</th>
							<th>Creation Date</th>
							<th>Expiration Date</th>
							<th>Last Used Date</th>
							<th>Status</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for key in current_user.api_keys|sort(attribute='id', reverse=True) %}
							<tr>
								{% if key.label %}
									<td>{{ key.label }}</td>
								{% else %}
									<td>
										<span class="text-body-secondary"
											>No label</span
										>
									</td>
								{% endif %}
								<td>{{ key.created_at | dbDateformat }}</td>
								{% if key.expires_at %}
									<td>{{ key.expires_at | dbDateformat }}</td>
								{% else %}
									<td>
										<span class="text-body-secondary"
											>Never</span
										>
									</td>
								{% endif %}
								{% if key.last_used %}
									<td>{{ key.last_used | dbDateformat }}</td>
								{% else %}
									<td>
										<span class="text-body-secondary"
											>Not used</span
										>
									</td>
								{% endif %}
								{% if key.is_active %}
									<td>
										<span class="badge text-bg-success"
											>Active</span
										>
									</td>
								{% else %}
									<td>
										<span class="badge text-bg-danger"
											>Revoked</span
										>
									</td>
								{% endif %}
								<td>
									{% if key.is_active %}
										<button
											class="btn btn-sm btn-outline-danger"
											onclick="revokeApiKey({{ key.id }})"
										>
											Revoke
										</button>
									{% else %}
										<span class="text-body-secondary"
											>-</span
										>
									{% endif %}
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		{% else %}
			<p class="card-text mb-4">
				<small class="text-body-secondary">
					You have not created any API keys yet.
				</small>
			</p>
		{% endif %}
	</div>
{% endblock content %}
{% block scripts %}
	{{ super() }}
	<script>
		function revokeApiKey(keyId) {
			if (!confirm("Are you sure you want to deactivate this API key?")) {
				return;
			}

			fetch(`{{ url_for("private_bp.api_keys") }}/revoke`, {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
					"X-CSRFToken": "{{ csrf_token() }}"
				},
				body: JSON.stringify({ key_id: keyId })
			})
				.then((response) => {
					if (response.ok) {
						location.reload();
					} else {
						alert("Failed to revoke API key");
					}
				})
				.catch((error) => {
					console.error("Error:", error);
					alert("An error occurred");
				});
		}
	</script>
{% endblock %}
